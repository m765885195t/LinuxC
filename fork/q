/*************************************************************************
	> File Name: mshell.c
	> Author:motian 
	> Mail:765885195@qq.com 
	> Created Time: 2016年07月25日 星期一 16时54分32秒
 ************************************************************************/

#include<stdio.h>
#include<sys/types.h>
#include<string.h>
#include<stdlib.h>
#include<sys/wait.h>
#include<unistd.h>
#include<fcntl.h>
#include<dirent.h>
#include<sys/stat.h>
#include<signal.h>

void shell(void);
void f(int);

void f(int signum) //接收到终止信号时的处理
{    
    char ch;//一开始输入终止怎么办?再加上输出格式和缓冲的问题
    printf("\n\33[7mmotian\033[0m:\n");
    //while((ch=getchar())!='\n')
    {
   //     printf("%c",ch);
    }
}

//解析命令并执行程序
void shell(void)
{
        
    char a[256],*b[100];   //a输入命令   b命令表
    int i,j,k,t,n=1,x=0,fd;
    pid_t pid;
    int stat_val;

    fgets(a,sizeof(a),stdin);  //输入命令
    
    if(strlen(a)>=256)
    {
        printf("command is too long\n");           //命令输入太长
        exit(-1);
    }
    
    a[strlen(a)-1]='\0';            //清'\n'

    while(1)
    {
        for(i=0,k=0,t=0;a[i];i++)
        {
            if(a[i]==' ')    //目前不处理多个空格的
            {
                if(i>k)
                {
                    t++;
                    k=i;
                }    
            }
        }
    
        if(n)
        {
            n--;
            b[t+1]=NULL;        //换一种方法
        }
        
        if(t)
        {
            b[t]=(a+k+1);
            a[k]='\0';  
        }
        else
        {
            b[t]=a;
            break;
        }
    }

    i=0;
    
    while(b[i]!=NULL)
    {
        
       if (x!=2  && strcmp(b[i],">")==0)
        {
           fd=creat(b[i+1],0644);
            x=1;
            b[i]=NULL;
        }
    
        if(x!=1 && strcmp(b[i],"<")==0)
        {
            fd=open(b[i+1],O_RDONLY);
            x=2;
            b[i]=NULL;
        }
        if(x!=1 && x!=2 && strcmp(b[i],"&")==0 )
        {
            x=3;
            b[i]=NULL;
        }

        i++;
    }
    
    if(!strcmp(b[0],"exit") || !strcmp(b[0],"logout"))
    {
        exit(0);
    }
    //解析命令
//-------------------------------------------
    //执行程序
    pid=fork();

    if(pid<0)
    {
        printf("创建进程失败\n");
        exit(-1);
    }
    
    if(pid==0)
    {
        if(x==1)            //1,输出,0输入
        {
            dup2(fd,1);
        }
        if(x==2)
        {
            dup2(fd,0);
        }
        
        execvp(b[0],b);   //子进程执行其他程序
        exit(0);
    }

    if(pid>0)
    {
        signal(SIGINT,f);
        wait(&stat_val);   //父进程等待中
        
    }
}

//主函数
int main()
{
     while(1)
    {
       // signal(SIGINT,f);
        printf("\33[7mmotian\033[0m:");
        signal(SIGINT,f);
        shell();
    }
}
